services:

  frontend:
    build: frontend
    ports:
      - "3001:3001"
    env_file: "frontend/.env"

  broker:
    build:
      context: broker
    ports:
      - "1883:1883"
    environment:
      - TLS_SERVER_KEY=${FLOTILLA_BROKER_SERVER_KEY}

  backend:
    build: backend
    ports:
      - "8000:8000"
    environment:
      # Overwrites the ip address for the Mqtt service to connect to the Mqtt container:
      - Mqtt__Host=broker
      - ASPNETCORE_ENVIRONMENT=Development
      - AZURE_CLIENT_SECRET=${FLOTILLA_CLIENT_SECRET}
      - OpenTelemetry__OtelExporterOtlpEndpoint=http://otel-collector:4318

  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard
    ports:
      - 18888:18888
      - 18889:18889
    environment:
      - ASPIRE_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.132.3
    command: ["--config=/conf/config.yaml"]
    ports:
      - "4317:4317"  # OTLP gRPC
      - "4318:4318"  # OTLP HTTP
    volumes:
      - ./config/otel-collector-config.yaml:/conf/config.yaml:ro
