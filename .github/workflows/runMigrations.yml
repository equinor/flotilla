name: RunMigrations

on:
  workflow_call:
    inputs:
      PullRequestCheckout:
        required: false
        type: boolean
      Environment:
        required: true
        type: string
    secrets:
      KeyVaultUrl:
        required: true
      ClientId:
        required: true
      ClientSecret:
        required: true

defaults:
  run:
    working-directory: backend/api

jobs:
  run_migrations:
    environment: ${{ inputs.Environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # Checks out to main branch by default, so we need to manually checkout to the PR the comment was made on
      # in order to do the update database on the new migrations.
      - name: Checkout Pull Request
        if: ${{ inputs.PullRequestCheckout }}
        run: hub pr checkout ${{ github.event.issue.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: "6.x.x"

      - name: Build project and dependencies
        run: dotnet build

      - name: Install dotnet ef tool
        run: dotnet tool install -g dotnet-ef

      - name: Update database
        run: dotnet ef database update --no-build --verbose
        env:
          AzureAd__ClientId: ${{ secrets.ClientId }}
          AzureAd__ClientSecret: ${{ secrets.ClientSecret }}
          ASPNETCORE_ENVIRONMENT: ${{ vars.AspNetEnvironment }}
